<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soundtrack Auto-Volume</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
    .db-bar { transition: width 0.3s ease; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen" x-data="app()" x-init="init()">

  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-xl font-bold text-white">Soundtrack Auto-Volume</h1>
      <div class="flex gap-2">
        <button @click="tab = 'devices'" :class="tab === 'devices' ? 'bg-indigo-600' : 'bg-gray-700 hover:bg-gray-600'" class="px-4 py-2 rounded text-sm font-medium transition">Devices</button>
        <button @click="tab = 'config'" :class="tab === 'config' ? 'bg-indigo-600' : 'bg-gray-700 hover:bg-gray-600'" class="px-4 py-2 rounded text-sm font-medium transition">Configure</button>
        <button @click="tab = 'monitor'" :class="tab === 'monitor' ? 'bg-indigo-600' : 'bg-gray-700 hover:bg-gray-600'" class="px-4 py-2 rounded text-sm font-medium transition">Monitor</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6">

    <!-- Devices Tab -->
    <div x-show="tab === 'devices'" x-cloak>
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold">Connected Devices</h2>
        <button @click="loadDevices()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm transition">Refresh</button>
      </div>

      <div x-show="devices.length === 0" class="text-gray-400 text-center py-12">
        No devices registered yet. Connect an ESP32 to get started.
      </div>

      <div class="grid gap-4">
        <template x-for="device in devices" :key="device.id">
          <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div :class="device.isOnline ? 'bg-green-500' : 'bg-red-500'" class="w-3 h-3 rounded-full"></div>
                <div>
                  <p class="font-medium" x-text="device.name || device.deviceId"></p>
                  <p class="text-sm text-gray-400" x-text="'ID: ' + device.deviceId"></p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm text-gray-400" x-text="device.lastDbLevel !== null ? device.lastDbLevel.toFixed(1) + ' dBFS' : 'No data'"></p>
                <p class="text-xs text-gray-500" x-text="device.lastSeen ? 'Last seen: ' + timeAgo(device.lastSeen) : ''"></p>
              </div>
            </div>
            <div class="mt-3" x-show="device.lastDbLevel !== null">
              <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                <div class="db-bar h-full rounded-full" :class="dbColor(device.lastDbLevel)" :style="'width: ' + dbPercent(device.lastDbLevel) + '%'"></div>
              </div>
            </div>
            <div class="mt-3 text-sm text-gray-400">
              <span x-text="(device.configs || []).length + ' zone config(s)'"></span>
              <button @click="selectDevice(device)" class="ml-4 text-indigo-400 hover:text-indigo-300" >Configure</button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Config Tab -->
    <div x-show="tab === 'config'" x-cloak>
      <h2 class="text-lg font-semibold mb-6">Zone Configuration</h2>

      <!-- Device Selector -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-400 mb-2">Select Device</label>
        <select x-model="selectedDeviceId" @change="loadDeviceConfigs()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 w-full max-w-md text-white">
          <option value="">-- Choose a device --</option>
          <template x-for="d in devices" :key="d.id">
            <option :value="d.id" x-text="d.name || d.deviceId"></option>
          </template>
        </select>
      </div>

      <!-- Existing Configs -->
      <div x-show="selectedDeviceId" class="mb-8">
        <h3 class="text-md font-medium mb-4">Active Zone Configs</h3>
        <div x-show="deviceConfigs.length === 0" class="text-gray-500 text-sm">No zone configs yet. Add one below.</div>
        <div class="grid gap-3">
          <template x-for="cfg in deviceConfigs" :key="cfg.id">
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <p class="font-medium" x-text="cfg.soundtrackZoneName || cfg.soundtrackZoneId"></p>
                  <p class="text-sm text-gray-400" x-text="cfg.soundtrackAccountName || cfg.soundtrackAccountId"></p>
                </div>
                <div class="flex items-center gap-3">
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" :checked="cfg.isEnabled" @change="toggleConfig(cfg)" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                  </label>
                  <button @click="deleteConfig(cfg.id)" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                </div>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                <div>
                  <span class="text-gray-400">Volume Range:</span>
                  <span x-text="cfg.minVolume + ' - ' + cfg.maxVolume"></span>
                </div>
                <div>
                  <span class="text-gray-400">Quiet:</span>
                  <span x-text="cfg.quietThresholdDb + ' dB'"></span>
                </div>
                <div>
                  <span class="text-gray-400">Loud:</span>
                  <span x-text="cfg.loudThresholdDb + ' dB'"></span>
                </div>
                <div>
                  <span class="text-gray-400">Current Vol:</span>
                  <span x-text="cfg.currentVolume"></span>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Add New Config -->
      <div x-show="selectedDeviceId" class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-md font-medium mb-4">Add Zone Config</h3>

        <!-- Account Search -->
        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Search Soundtrack Account</label>
          <div class="flex gap-2">
            <input type="text" x-model="accountSearch" @keydown.enter="searchAccounts()" placeholder="Type account name..." class="bg-gray-700 border border-gray-600 rounded px-3 py-2 flex-1 text-white placeholder-gray-500">
            <button @click="searchAccounts()" :disabled="searching" class="bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-600 px-4 py-2 rounded text-sm transition">
              <span x-show="!searching">Search</span>
              <span x-show="searching">...</span>
            </button>
          </div>
        </div>

        <!-- Account Results -->
        <div x-show="accounts.length > 0" class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Select Account</label>
          <select x-model="selectedAccountId" @change="loadZones()" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white">
            <option value="">-- Choose account --</option>
            <template x-for="acct in accounts" :key="acct.id">
              <option :value="acct.id" x-text="acct.name"></option>
            </template>
          </select>
        </div>

        <!-- Zone Results -->
        <div x-show="zones.length > 0" class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Select Zone</label>
          <select x-model="selectedZoneId" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white">
            <option value="">-- Choose zone --</option>
            <template x-for="z in zones" :key="z.id">
              <option :value="z.id" x-text="z.name + ' (' + z.locationName + ')'"></option>
            </template>
          </select>
        </div>

        <!-- Thresholds -->
        <div x-show="selectedZoneId" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Min Volume (0-16)</label>
              <input type="number" x-model.number="newConfig.minVolume" min="0" max="16" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Max Volume (0-16)</label>
              <input type="number" x-model.number="newConfig.maxVolume" min="0" max="16" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Quiet Threshold (dBFS)</label>
              <input type="number" x-model.number="newConfig.quietThresholdDb" step="1" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Loud Threshold (dBFS)</label>
              <input type="number" x-model.number="newConfig.loudThresholdDb" step="1" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white">
            </div>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Smoothing Factor (0.1-0.9)</label>
            <input type="range" x-model.number="newConfig.smoothingFactor" min="0.1" max="0.9" step="0.1" class="w-full max-w-md">
            <span class="text-sm text-gray-400 ml-2" x-text="newConfig.smoothingFactor"></span>
          </div>

          <button @click="addConfig()" :disabled="saving" class="bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-600 px-6 py-2 rounded text-sm font-medium transition">
            <span x-show="!saving">Add Zone Config</span>
            <span x-show="saving">Saving...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Monitor Tab -->
    <div x-show="tab === 'monitor'" x-cloak>
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold">Live Monitor</h2>
        <div class="flex items-center gap-3">
          <span class="text-sm text-gray-400" x-text="monitoring ? 'Polling every 2s' : 'Paused'"></span>
          <button @click="toggleMonitoring()" :class="monitoring ? 'bg-red-600 hover:bg-red-500' : 'bg-green-600 hover:bg-green-500'" class="px-4 py-1.5 rounded text-sm transition">
            <span x-text="monitoring ? 'Stop' : 'Start'"></span>
          </button>
        </div>
      </div>

      <div x-show="devices.length === 0" class="text-gray-400 text-center py-12">
        No devices available to monitor.
      </div>

      <div class="grid gap-4">
        <template x-for="device in devices.filter(d => d.isOnline)" :key="device.id">
          <div class="bg-gray-800 rounded-lg p-5 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                <p class="font-medium" x-text="device.name || device.deviceId"></p>
              </div>
              <p class="text-2xl font-mono font-bold" :class="dbColor(device.lastDbLevel)" x-text="device.lastDbLevel !== null ? device.lastDbLevel.toFixed(1) + ' dB' : '--'"></p>
            </div>

            <!-- dB Level Bar -->
            <div class="mb-4">
              <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span>-60 dB</span>
                <span>-40</span>
                <span>-20</span>
                <span>0 dB</span>
              </div>
              <div class="h-4 bg-gray-700 rounded-full overflow-hidden">
                <div class="db-bar h-full rounded-full" :class="dbColor(device.lastDbLevel)" :style="'width: ' + dbPercent(device.lastDbLevel) + '%'"></div>
              </div>
            </div>

            <!-- Zone configs for this device -->
            <template x-for="cfg in (device.configs || []).filter(c => c.isEnabled)" :key="cfg.id">
              <div class="flex items-center justify-between py-2 border-t border-gray-700">
                <span class="text-sm" x-text="cfg.soundtrackZoneName || cfg.soundtrackZoneId"></span>
                <div class="flex items-center gap-4">
                  <div class="flex items-center gap-1">
                    <template x-for="i in 17" :key="i">
                      <div class="w-2 h-4 rounded-sm" :class="(i-1) <= cfg.currentVolume ? 'bg-indigo-500' : 'bg-gray-600'"></div>
                    </template>
                  </div>
                  <span class="text-sm font-mono w-8 text-right" x-text="cfg.currentVolume"></span>
                </div>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>

    <!-- Toast notifications -->
    <div x-show="toast.show" x-transition class="fixed bottom-6 right-6 px-4 py-3 rounded-lg shadow-lg text-sm" :class="toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'">
      <span x-text="toast.message"></span>
    </div>

  </main>

  <script>
    const API = window.location.origin + '/api';

    function app() {
      return {
        tab: 'devices',
        devices: [],
        deviceConfigs: [],
        selectedDeviceId: '',
        accounts: [],
        zones: [],
        selectedAccountId: '',
        selectedZoneId: '',
        accountSearch: '',
        searching: false,
        saving: false,
        monitoring: false,
        monitorInterval: null,
        toast: { show: false, message: '', type: 'success' },
        newConfig: {
          minVolume: 2,
          maxVolume: 14,
          quietThresholdDb: -40,
          loudThresholdDb: -10,
          smoothingFactor: 0.3,
        },

        async init() {
          await this.loadDevices();
        },

        async loadDevices() {
          try {
            const res = await fetch(`${API}/devices`);
            this.devices = await res.json();
          } catch (e) {
            this.showToast('Failed to load devices', 'error');
          }
        },

        selectDevice(device) {
          this.selectedDeviceId = device.id;
          this.tab = 'config';
          this.loadDeviceConfigs();
        },

        async loadDeviceConfigs() {
          if (!this.selectedDeviceId) { this.deviceConfigs = []; return; }
          try {
            const res = await fetch(`${API}/configs/device/${this.selectedDeviceId}`);
            this.deviceConfigs = await res.json();
          } catch (e) {
            this.showToast('Failed to load configs', 'error');
          }
        },

        async searchAccounts() {
          if (!this.accountSearch.trim()) return;
          this.searching = true;
          this.accounts = [];
          this.zones = [];
          this.selectedAccountId = '';
          this.selectedZoneId = '';
          try {
            const res = await fetch(`${API}/soundtrack/accounts?q=${encodeURIComponent(this.accountSearch)}`);
            this.accounts = await res.json();
            if (this.accounts.length === 0) this.showToast('No accounts found', 'error');
          } catch (e) {
            this.showToast('Search failed', 'error');
          }
          this.searching = false;
        },

        async loadZones() {
          if (!this.selectedAccountId) { this.zones = []; return; }
          this.zones = [];
          this.selectedZoneId = '';
          try {
            const res = await fetch(`${API}/soundtrack/accounts/${this.selectedAccountId}/zones`);
            this.zones = await res.json();
          } catch (e) {
            this.showToast('Failed to load zones', 'error');
          }
        },

        async addConfig() {
          if (!this.selectedDeviceId || !this.selectedZoneId) return;
          this.saving = true;
          const zone = this.zones.find(z => z.id === this.selectedZoneId);
          const account = this.accounts.find(a => a.id === this.selectedAccountId);
          try {
            const res = await fetch(`${API}/configs`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                deviceId: this.selectedDeviceId,
                soundtrackAccountId: this.selectedAccountId,
                soundtrackAccountName: account?.name || '',
                soundtrackZoneId: this.selectedZoneId,
                soundtrackZoneName: zone?.name || '',
                ...this.newConfig,
              }),
            });
            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Failed to save');
            }
            this.showToast('Zone config added!', 'success');
            this.selectedAccountId = '';
            this.selectedZoneId = '';
            this.accounts = [];
            this.zones = [];
            this.accountSearch = '';
            await this.loadDeviceConfigs();
          } catch (e) {
            this.showToast(e.message, 'error');
          }
          this.saving = false;
        },

        async toggleConfig(cfg) {
          try {
            await fetch(`${API}/configs/${cfg.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ isEnabled: !cfg.isEnabled }),
            });
            cfg.isEnabled = !cfg.isEnabled;
          } catch (e) {
            this.showToast('Failed to update config', 'error');
          }
        },

        async deleteConfig(id) {
          if (!confirm('Delete this zone config?')) return;
          try {
            await fetch(`${API}/configs/${id}`, { method: 'DELETE' });
            this.deviceConfigs = this.deviceConfigs.filter(c => c.id !== id);
            this.showToast('Config deleted', 'success');
          } catch (e) {
            this.showToast('Failed to delete', 'error');
          }
        },

        toggleMonitoring() {
          if (this.monitoring) {
            clearInterval(this.monitorInterval);
            this.monitorInterval = null;
            this.monitoring = false;
          } else {
            this.monitoring = true;
            this.loadDevices();
            this.monitorInterval = setInterval(() => this.loadDevices(), 2000);
          }
        },

        dbPercent(db) {
          if (db === null || db === undefined) return 0;
          return Math.max(0, Math.min(100, ((db + 60) / 60) * 100));
        },

        dbColor(db) {
          if (db === null || db === undefined) return 'bg-gray-500';
          if (db > -10) return 'bg-red-500';
          if (db > -25) return 'bg-yellow-500';
          return 'bg-green-500';
        },

        timeAgo(dateStr) {
          const diff = Date.now() - new Date(dateStr).getTime();
          const secs = Math.floor(diff / 1000);
          if (secs < 60) return secs + 's ago';
          const mins = Math.floor(secs / 60);
          if (mins < 60) return mins + 'm ago';
          const hrs = Math.floor(mins / 60);
          if (hrs < 24) return hrs + 'h ago';
          return Math.floor(hrs / 24) + 'd ago';
        },

        showToast(message, type = 'success') {
          this.toast = { show: true, message, type };
          setTimeout(() => { this.toast.show = false; }, 3000);
        },
      };
    }
  </script>
</body>
</html>
