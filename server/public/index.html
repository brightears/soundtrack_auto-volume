<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto-Volume | BMAsia</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { orange: '#EFA634', 'orange-dark': '#d99530', dark: '#0f0f0f', navy: '#1a1a2e' }
          }
        }
      }
    }
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
    .db-bar { transition: width 0.3s ease; }
    /* Customer mode brand styles */
    .customer-mode { font-family: 'Inter', sans-serif; }
    .glass {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    /* Custom range sliders — customer mode only */
    .customer-mode input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; }
    .customer-mode input[type="range"]::-webkit-slider-track { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
    .customer-mode input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #EFA634; margin-top: -6px; box-shadow: 0 0 8px rgba(239,166,52,0.3); }
    .customer-mode input[type="range"]::-moz-range-track { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; border: none; }
    .customer-mode input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: #EFA634; border: none; box-shadow: 0 0 8px rgba(239,166,52,0.3); }
    .customer-mode input[type="range"]:focus { outline: none; }
    .customer-mode input[type="range"]:focus::-webkit-slider-thumb { box-shadow: 0 0 12px rgba(239,166,52,0.5); }
  </style>
</head>
<body :class="isCustomerMode ? 'bg-brand-dark customer-mode' : 'bg-gray-900'" class="text-gray-100 min-h-screen flex flex-col" x-data="app()" x-init="init()">

  <!-- Header -->
  <header :class="isCustomerMode ? 'bg-brand-dark' : 'bg-gray-800 border-b border-gray-700'" class="px-8 py-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <!-- Customer mode: logo only -->
      <template x-if="isCustomerMode">
        <img src="/logo.png" alt="BMAsia" class="h-10">
      </template>
      <!-- Admin mode: text title -->
      <template x-if="!isCustomerMode">
        <h1 class="text-xl font-bold text-white">Soundtrack Auto-Volume</h1>
      </template>
      <div class="flex gap-2 items-center">
        <!-- Admin tabs (hidden in customer mode) -->
        <template x-if="!isCustomerMode">
          <div class="flex gap-2 items-center">
            <button @click="switchTab('devices')" :class="tab === 'devices' ? 'bg-indigo-600' : 'bg-gray-700 hover:bg-gray-600'" class="px-4 py-2 rounded text-sm font-medium transition">Devices</button>
            <button @click="switchTab('config')" :class="tab === 'config' ? 'bg-indigo-600' : 'bg-gray-700 hover:bg-gray-600'" class="px-4 py-2 rounded text-sm font-medium transition">Configure</button>
            <button @click="switchTab('monitor')" :class="tab === 'monitor' ? 'bg-indigo-600' : 'bg-gray-700 hover:bg-gray-600'" class="px-4 py-2 rounded text-sm font-medium transition">Monitor</button>
          </div>
        </template>
        <button @click="showHelp = !showHelp" :class="isCustomerMode ? 'w-9 h-9 rounded-full flex items-center justify-center ' + (showHelp ? 'bg-brand-orange/20 text-brand-orange border-brand-orange/50' : 'border-white/15 text-gray-500 hover:text-brand-orange hover:border-brand-orange/40') : 'px-3 py-2 rounded-lg ' + (showHelp ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600')" class="text-sm font-medium transition border border-transparent" title="Toggle help tips">?</button>
      </div>
    </div>
    <div x-show="isCustomerMode" class="h-0.5 bg-gradient-to-r from-brand-orange to-brand-orange/0 mt-3"></div>
  </header>

  <main class="max-w-6xl mx-auto p-6 flex-1">

    <!-- ==================== CUSTOMER MODE ==================== -->
    <template x-if="isCustomerMode">
      <div>
        <!-- Subtle radial gradient overlay -->
        <div class="fixed inset-0 pointer-events-none" style="background: radial-gradient(ellipse at top center, rgba(239,166,52,0.04) 0%, transparent 60%);"></div>

        <!-- Help panel — orange accent -->
        <div x-show="showHelp" x-transition class="mb-6 rounded-2xl p-5 text-sm space-y-3" style="background: rgba(239,166,52,0.05); border: 1px solid rgba(239,166,52,0.2);">
          <p class="text-brand-orange font-medium">How Auto-Volume works</p>
          <p class="text-gray-400">The device's microphone measures ambient noise. When the room gets louder (more guests, conversations), the music volume goes up so it stays audible. When it gets quieter, the volume comes back down.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-gray-400">
            <div><strong class="text-gray-300">Sensitivity</strong> &mdash; How much noise triggers a change. Low = only big shifts. High = reacts to conversations. <span class="text-brand-orange">Recommended: Medium</span></div>
            <div><strong class="text-gray-300">Reactivity</strong> &mdash; How fast volume adjusts. Low = smooth gradual changes. High = near-instant. <span class="text-brand-orange">Recommended: Low-Medium</span></div>
            <div><strong class="text-gray-300">Min Volume</strong> &mdash; Quietest music goes (0-16). <span class="text-brand-orange">Recommended: 4-5</span></div>
            <div><strong class="text-gray-300">Max Volume</strong> &mdash; Loudest music goes (0-16). <span class="text-brand-orange">Recommended: 10-12</span></div>
          </div>
        </div>

        <!-- No devices state -->
        <div x-show="devices.length === 0" class="text-center py-16">
          <h2 class="text-2xl font-semibold text-white mb-3">Setting Up Your Auto-Volume</h2>
          <p class="text-gray-400 mb-8 max-w-md mx-auto">Power on your device. It will create a WiFi network called <strong class="text-gray-300">AutoVolume-XXXX</strong>. Connect to it, enter your WiFi password and Account ID, then return here.</p>
          <div class="inline-flex items-center gap-2 text-gray-500 text-sm">
            <svg class="animate-spin h-4 w-4 text-brand-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
            Waiting for device to connect...
          </div>
        </div>

        <!-- Device cards -->
        <div class="space-y-6">
          <template x-for="device in devices" :key="device.id">
            <div class="glass rounded-2xl overflow-hidden">
              <!-- Device header -->
              <div class="p-5">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-3">
                    <div :class="device.isOnline ? 'bg-green-500/80 animate-pulse' : 'bg-red-500/80'" class="w-2.5 h-2.5 rounded-full"></div>
                    <div>
                      <div x-show="renamingDeviceId !== device.id" class="flex items-center gap-2">
                        <h2 class="text-lg font-semibold" x-text="deviceDisplayName(device)"></h2>
                        <button @click="startRename(device)" class="text-gray-500 hover:text-gray-300 transition">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                      </div>
                      <div x-show="renamingDeviceId === device.id" class="flex items-center gap-2">
                        <input type="text" x-model="renameValue" @keydown.enter="saveRename(device)" @keydown.escape="renamingDeviceId = null" class="bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-sm text-white w-48 focus:ring-1 focus:ring-brand-orange focus:border-brand-orange outline-none">
                        <button @click="saveRename(device)" class="text-green-400 text-xs">Save</button>
                        <button @click="renamingDeviceId = null" class="text-gray-400 text-xs">Cancel</button>
                      </div>
                      <p class="text-xs text-gray-500" x-text="device.isOnline ? 'Online' : 'Offline — last seen ' + timeAgo(device.lastSeen)"></p>
                    </div>
                  </div>
                  <p class="text-2xl font-mono font-bold text-brand-orange" x-text="device.lastDbLevel !== null ? device.lastDbLevel.toFixed(1) + ' dB' : '--'"></p>
                </div>

                <!-- dB bar -->
                <div x-show="device.lastDbLevel !== null" class="mb-2">
                  <div class="flex justify-between text-xs text-gray-600 mb-1">
                    <span>-80 dB</span><span>-60</span><span>-40</span><span>-20 dB</span>
                  </div>
                  <div class="h-2.5 bg-white/5 rounded-full overflow-hidden">
                    <div class="db-bar h-full rounded-full" :class="dbColor(device.lastDbLevel)" :style="'width: ' + dbPercent(device.lastDbLevel) + '%'"></div>
                  </div>
                </div>
              </div>

              <!-- Zone configs -->
              <template x-for="cfg in (device.configs || [])" :key="cfg.id">
                <div class="border-t border-white/10 p-5">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                      <span class="font-medium" x-text="cfg.soundtrackZoneName || cfg.soundtrackZoneId"></span>
                      <template x-if="cfg.isPaused">
                        <span class="text-xs bg-yellow-600/20 text-yellow-400 px-2 py-0.5 rounded-md">PAUSED</span>
                      </template>
                    </div>
                    <div class="flex items-center gap-3">
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" :checked="cfg.isEnabled" @change="toggleConfig(cfg)" class="sr-only peer">
                        <div class="w-9 h-5 bg-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-brand-orange"></div>
                      </label>
                      <button @click="toggleZonePause(cfg)" :class="cfg.isPaused ? 'text-green-400 hover:text-green-300' : 'text-gray-400 hover:text-yellow-400'" class="transition" :title="cfg.isPaused ? 'Resume auto-volume' : 'Pause auto-volume'">
                        <svg x-show="!cfg.isPaused" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <svg x-show="cfg.isPaused" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                      </button>
                      <button @click="deleteConfig(cfg.id, device)" class="text-gray-500 hover:text-red-400 transition" title="Remove zone">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                      </button>
                    </div>
                  </div>

                  <!-- Volume bar + number -->
                  <div x-show="cfg.isEnabled" class="space-y-3" :class="cfg.isPaused ? 'opacity-50' : ''">
                    <div class="flex items-center gap-3">
                      <div class="flex items-center gap-0.5 flex-1">
                        <template x-for="i in 17" :key="i">
                          <div class="flex-1 h-5 rounded-sm transition-colors" :class="(i-1) <= cfg.currentVolume ? 'bg-brand-orange' : 'bg-white/10'"></div>
                        </template>
                      </div>
                      <span class="text-lg font-mono font-bold w-8 text-right" x-text="cfg.currentVolume"></span>
                    </div>

                    <!-- Inline controls -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                          <span>Sensitivity</span>
                          <span x-text="sensitivityLabel(paramsToSensitivity(cfg.quietThresholdDb, cfg.loudThresholdDb))"></span>
                        </div>
                        <input type="range" :value="paramsToSensitivity(cfg.quietThresholdDb, cfg.loudThresholdDb)" @change="quickUpdateSensitivity(cfg, $event.target.value)" min="1" max="5" step="1" class="w-full">
                        <div class="flex justify-between text-xs text-gray-600"><span>Low</span><span>High</span></div>
                      </div>
                      <div>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                          <span>Reactivity</span>
                          <span x-text="reactivityLabel(paramsToReactivity(cfg.smoothingFactor, cfg.sustainCount || 2))"></span>
                        </div>
                        <input type="range" :value="paramsToReactivity(cfg.smoothingFactor, cfg.sustainCount || 2)" @change="quickUpdateReactivity(cfg, $event.target.value)" min="1" max="5" step="1" class="w-full">
                        <div class="flex justify-between text-xs text-gray-600"><span>Slow</span><span>Fast</span></div>
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="text-xs text-gray-400">Min Volume</label>
                        <input type="number" :value="cfg.minVolume" @change="quickUpdateField(cfg, 'minVolume', parseInt($event.target.value))" min="0" max="16" class="bg-white/5 border border-white/10 rounded-lg px-2 py-1 w-full text-white text-sm focus:ring-1 focus:ring-brand-orange focus:border-brand-orange outline-none">
                      </div>
                      <div>
                        <label class="text-xs text-gray-400">Max Volume</label>
                        <input type="number" :value="cfg.maxVolume" @change="quickUpdateField(cfg, 'maxVolume', parseInt($event.target.value))" min="0" max="16" class="bg-white/5 border border-white/10 rounded-lg px-2 py-1 w-full text-white text-sm focus:ring-1 focus:ring-brand-orange focus:border-brand-orange outline-none">
                      </div>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Add Zone button -->
              <div class="border-t border-white/10 p-4">
                <template x-if="!addingZoneForDevice || addingZoneForDevice !== device.id">
                  <button @click="startAddZone(device)" class="w-full py-2 rounded-lg border border-dashed border-white/20 text-gray-500 hover:text-brand-orange hover:border-brand-orange/50 text-sm transition">
                    + Add Zone
                  </button>
                </template>
                <template x-if="addingZoneForDevice === device.id">
                  <div class="space-y-3">
                    <div x-show="customerZones.length === 0" class="text-center py-4 text-gray-500 text-sm">
                      <svg class="animate-spin h-4 w-4 mx-auto mb-2 text-brand-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                      Loading zones...
                    </div>
                    <div x-show="customerZones.length > 0" class="space-y-2 max-h-48 overflow-y-auto">
                      <template x-for="z in customerZones" :key="z.id">
                        <button @click="addZoneToDevice(device, z)" class="w-full text-left bg-white/5 hover:bg-white/10 rounded-lg p-3 text-sm transition border border-white/5 hover:border-white/10">
                          <p class="font-medium" x-text="z.name"></p>
                          <p class="text-xs text-gray-400" x-text="z.locationName"></p>
                        </button>
                      </template>
                    </div>
                    <button @click="addingZoneForDevice = null" class="text-xs text-gray-400 hover:text-gray-300">Cancel</button>
                  </div>
                </template>
              </div>

              <!-- Reset device -->
              <div class="border-t border-white/10 p-4 flex justify-end">
                <button @click="resetDevice(device)" class="text-xs text-gray-600 hover:text-red-400 transition">Reset Device</button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- ==================== ADMIN MODE ==================== -->
    <template x-if="!isCustomerMode">
      <div>
        <!-- New Device Banner -->
        <template x-if="unconfiguredOnlineDevices().length > 0 && !wizard.active">
          <div class="mb-6 bg-indigo-900/50 border border-indigo-500/50 rounded-lg p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
              <span class="text-sm">
                New device detected: <strong x-text="deviceDisplayName(unconfiguredOnlineDevices()[0])"></strong>
              </span>
            </div>
            <button @click="startWizard(unconfiguredOnlineDevices()[0])" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded text-sm font-medium transition">Set Up</button>
          </div>
        </template>

        <!-- Devices Tab -->
        <div x-show="tab === 'devices'" x-cloak>
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Connected Devices</h2>
            <button @click="loadDevices()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm transition">Refresh</button>
          </div>

          <div x-show="devices.length === 0" class="text-center py-12">
            <h3 class="text-xl font-semibold text-white mb-2">Welcome to Auto-Volume</h3>
            <p class="text-gray-400 mb-8">Automatically adjusts your Soundtrack Your Brand music volume based on ambient noise.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-2xl mx-auto text-left">
              <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-indigo-400 font-bold text-lg mb-1">1. Connect</div>
                <p class="text-sm text-gray-400">Power on your ESP32 device. It will create a WiFi network called <strong class="text-gray-300">AutoVolume-XXXX</strong>. Connect to it and enter your WiFi password.</p>
              </div>
              <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-indigo-400 font-bold text-lg mb-1">2. Set Up</div>
                <p class="text-sm text-gray-400">Once connected, your device will appear here. Use the <strong class="text-gray-300">Quick Setup</strong> wizard to link it to a Soundtrack zone.</p>
              </div>
              <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-indigo-400 font-bold text-lg mb-1">3. Monitor</div>
                <p class="text-sm text-gray-400">Go to the <strong class="text-gray-300">Monitor</strong> tab to see live noise levels and volume adjustments in real time.</p>
              </div>
            </div>
          </div>

          <div class="grid gap-4">
            <template x-for="device in devices" :key="device.id">
              <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div :class="device.isOnline ? 'bg-green-500' : 'bg-red-500'" class="w-3 h-3 rounded-full"></div>
                    <div>
                      <div x-show="renamingDeviceId !== device.id" class="flex items-center gap-2">
                        <p class="font-medium" x-text="deviceDisplayName(device)"></p>
                        <button @click="startRename(device)" class="text-gray-500 hover:text-gray-300 text-xs" title="Rename">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                      </div>
                      <div x-show="renamingDeviceId === device.id" class="flex items-center gap-2">
                        <input type="text" x-model="renameValue" @keydown.enter="saveRename(device)" @keydown.escape="renamingDeviceId = null" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white w-48">
                        <button @click="saveRename(device)" class="text-green-400 text-xs">Save</button>
                        <button @click="renamingDeviceId = null" class="text-gray-400 text-xs">Cancel</button>
                      </div>
                      <p class="text-sm text-gray-400" x-text="'ID: ' + device.deviceId"></p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="text-sm text-gray-400" x-text="device.lastDbLevel !== null ? device.lastDbLevel.toFixed(1) + ' dBFS' : 'No data'"></p>
                    <p class="text-xs text-gray-500" x-text="device.lastSeen ? 'Last seen: ' + timeAgo(device.lastSeen) : ''"></p>
                  </div>
                </div>
                <div class="mt-3" x-show="device.lastDbLevel !== null">
                  <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div class="db-bar h-full rounded-full" :class="dbColor(device.lastDbLevel)" :style="'width: ' + dbPercent(device.lastDbLevel) + '%'"></div>
                  </div>
                </div>
                <div class="mt-3 flex items-center justify-between text-sm text-gray-400">
                  <div class="flex items-center gap-4">
                    <span x-text="(device.configs || []).length + ' zone config(s)'"></span>
                    <button @click="selectDevice(device)" class="text-indigo-400 hover:text-indigo-300">Configure</button>
                    <template x-if="(device.configs || []).length === 0 && device.isOnline">
                      <button @click="startWizard(device)" class="text-green-400 hover:text-green-300">Quick Setup</button>
                    </template>
                  </div>
                  <template x-if="device.firmware">
                    <span class="text-xs text-gray-600" x-text="'fw: ' + device.firmware"></span>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Config Tab -->
        <div x-show="tab === 'config'" x-cloak>
          <h2 class="text-lg font-semibold mb-4">Zone Configuration</h2>

          <div x-show="showHelp" x-transition class="mb-6 bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 text-sm space-y-3">
            <p class="text-blue-300 font-medium">How Auto-Volume works</p>
            <p class="text-gray-400">The device's microphone measures ambient noise. When the room gets louder, the music volume goes up. When it gets quieter, the volume comes back down.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-gray-400">
              <div><strong class="text-gray-300">Sensitivity</strong> &mdash; How much noise triggers a change. <span class="text-blue-400">Recommended: Medium</span></div>
              <div><strong class="text-gray-300">Reactivity</strong> &mdash; How fast volume adjusts. <span class="text-blue-400">Recommended: Low-Medium</span></div>
              <div><strong class="text-gray-300">Min Volume</strong> &mdash; Quietest (0-16). <span class="text-blue-400">Recommended: 4-5</span></div>
              <div><strong class="text-gray-300">Max Volume</strong> &mdash; Loudest (0-16). <span class="text-blue-400">Recommended: 10-12</span></div>
            </div>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-400 mb-2">Select Device</label>
            <select x-model="selectedDeviceId" @change="loadDeviceConfigs()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 w-full max-w-md text-white">
              <option value="">-- Choose a device --</option>
              <template x-for="d in devices" :key="d.id">
                <option :value="d.id" x-text="deviceDisplayName(d)"></option>
              </template>
            </select>
          </div>

          <div x-show="selectedDeviceId" class="mb-8">
            <h3 class="text-md font-medium mb-4">Active Zone Configs</h3>
            <div x-show="deviceConfigs.length === 0" class="text-gray-500 text-sm">No zone configs yet. Add one below.</div>
            <div class="grid gap-3">
              <template x-for="cfg in deviceConfigs" :key="cfg.id">
                <div class="bg-gray-800 rounded-lg border border-gray-700">
                  <div class="p-4">
                    <div class="flex items-center justify-between mb-3">
                      <div>
                        <p class="font-medium" x-text="cfg.soundtrackZoneName || cfg.soundtrackZoneId"></p>
                        <p class="text-sm text-gray-400" x-text="cfg.soundtrackAccountName || cfg.soundtrackAccountId"></p>
                      </div>
                      <div class="flex items-center gap-3">
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" :checked="cfg.isEnabled" @change="toggleConfig(cfg)" class="sr-only peer">
                          <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                        <button @click="toggleEditConfig(cfg)" :class="editingConfigId === cfg.id ? 'text-indigo-400' : 'text-gray-400 hover:text-gray-300'" class="text-sm">Settings</button>
                        <button @click="deleteConfig(cfg.id)" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                      </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                      <div><span class="text-gray-400">Volume:</span> <span x-text="cfg.minVolume + ' - ' + cfg.maxVolume"></span></div>
                      <div><span class="text-gray-400">Sensitivity:</span> <span x-text="sensitivityLabel(paramsToSensitivity(cfg.quietThresholdDb, cfg.loudThresholdDb))"></span></div>
                      <div><span class="text-gray-400">Reactivity:</span> <span x-text="reactivityLabel(paramsToReactivity(cfg.smoothingFactor, cfg.sustainCount || 2))"></span></div>
                      <div><span class="text-gray-400">Current Vol:</span> <span x-text="cfg.currentVolume"></span></div>
                    </div>
                  </div>
                  <div x-show="editingConfigId === cfg.id" x-transition class="border-t border-gray-700 p-4 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                      <div><label class="block text-sm text-gray-400 mb-1">Min Volume</label><input type="number" x-model.number="editConfig.minVolume" min="0" max="16" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white"></div>
                      <div><label class="block text-sm text-gray-400 mb-1">Max Volume</label><input type="number" x-model.number="editConfig.maxVolume" min="0" max="16" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white"></div>
                    </div>
                    <div>
                      <div class="flex justify-between items-center mb-1"><label class="text-sm text-gray-400">Sensitivity</label><span class="text-sm text-gray-300" x-text="sensitivityLabel(editConfig.sensitivity)"></span></div>
                      <input type="range" x-model.number="editConfig.sensitivity" min="1" max="5" step="1" class="w-full">
                    </div>
                    <div>
                      <div class="flex justify-between items-center mb-1"><label class="text-sm text-gray-400">Reactivity</label><span class="text-sm text-gray-300" x-text="reactivityLabel(editConfig.reactivity)"></span></div>
                      <input type="range" x-model.number="editConfig.reactivity" min="1" max="5" step="1" class="w-full">
                    </div>
                    <div class="flex gap-3 pt-2">
                      <button @click="saveConfigSettings(cfg)" :disabled="savingConfig" class="bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-600 px-4 py-2 rounded text-sm font-medium transition"><span x-show="!savingConfig">Save</span><span x-show="savingConfig">Saving...</span></button>
                      <button @click="editingConfigId = null" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm transition">Cancel</button>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <div x-show="selectedDeviceId" class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-md font-medium mb-4">Add Zone Config</h3>
            <div class="mb-4">
              <label class="block text-sm text-gray-400 mb-1">Search Soundtrack Account</label>
              <div class="flex gap-2">
                <input type="text" x-model="accountSearch" @keydown.enter="searchAccounts()" placeholder="Type account name..." class="bg-gray-700 border border-gray-600 rounded px-3 py-2 flex-1 text-white placeholder-gray-500">
                <button @click="searchAccounts()" :disabled="searching" class="bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-600 px-4 py-2 rounded text-sm transition"><span x-show="!searching">Search</span><span x-show="searching">...</span></button>
              </div>
            </div>
            <div x-show="accounts.length > 0" class="mb-4">
              <label class="block text-sm text-gray-400 mb-1">Select Account</label>
              <select x-model="selectedAccountId" @change="loadZones()" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white">
                <option value="">-- Choose account --</option>
                <template x-for="acct in accounts" :key="acct.id"><option :value="acct.id" x-text="acct.name"></option></template>
              </select>
            </div>
            <div x-show="zones.length > 0" class="mb-4">
              <label class="block text-sm text-gray-400 mb-1">Select Zone</label>
              <select x-model="selectedZoneId" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white">
                <option value="">-- Choose zone --</option>
                <template x-for="z in zones" :key="z.id"><option :value="z.id" x-text="z.name + ' (' + z.locationName + ')'"></option></template>
              </select>
            </div>
            <div x-show="selectedZoneId" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm text-gray-400 mb-1">Min Volume</label><input type="number" x-model.number="newConfig.minVolume" min="0" max="16" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white"></div>
                <div><label class="block text-sm text-gray-400 mb-1">Max Volume</label><input type="number" x-model.number="newConfig.maxVolume" min="0" max="16" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 w-full text-white"></div>
              </div>
              <div>
                <div class="flex justify-between items-center mb-1"><label class="text-sm text-gray-400">Sensitivity</label><span class="text-sm text-gray-300" x-text="sensitivityLabel(newConfig.sensitivity)"></span></div>
                <input type="range" x-model.number="newConfig.sensitivity" min="1" max="5" step="1" class="w-full">
              </div>
              <div>
                <div class="flex justify-between items-center mb-1"><label class="text-sm text-gray-400">Reactivity</label><span class="text-sm text-gray-300" x-text="reactivityLabel(newConfig.reactivity)"></span></div>
                <input type="range" x-model.number="newConfig.reactivity" min="1" max="5" step="1" class="w-full">
              </div>
              <button @click="addConfig()" :disabled="saving" class="bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-600 px-6 py-2 rounded text-sm font-medium transition"><span x-show="!saving">Add Zone Config</span><span x-show="saving">Saving...</span></button>
            </div>
          </div>
        </div>

        <!-- Monitor Tab -->
        <div x-show="tab === 'monitor'" x-cloak>
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold">Live Monitor</h2>
            <div class="flex items-center gap-3">
              <span class="text-sm text-gray-400" x-text="monitoring ? 'Polling every 2s' : 'Paused'"></span>
              <button @click="toggleMonitoring()" :class="monitoring ? 'bg-red-600 hover:bg-red-500' : 'bg-green-600 hover:bg-green-500'" class="px-4 py-1.5 rounded text-sm transition">
                <span x-text="monitoring ? 'Stop' : 'Start'"></span>
              </button>
            </div>
          </div>

          <div x-show="devices.length === 0" class="text-gray-400 text-center py-12">No devices available to monitor.</div>

          <div class="grid gap-4">
            <template x-for="device in devices.filter(d => d.isOnline)" :key="device.id">
              <div class="bg-gray-800 rounded-lg p-5 border border-gray-700">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-3">
                    <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                    <p class="font-medium" x-text="deviceDisplayName(device)"></p>
                  </div>
                  <p class="text-2xl font-mono font-bold" :class="dbColor(device.lastDbLevel)" x-text="device.lastDbLevel !== null ? device.lastDbLevel.toFixed(1) + ' dB' : '--'"></p>
                </div>
                <div class="mb-4">
                  <div class="flex justify-between text-xs text-gray-500 mb-1"><span>-80 dB</span><span>-60</span><span>-40</span><span>-20 dB</span></div>
                  <div class="h-4 bg-gray-700 rounded-full overflow-hidden">
                    <div class="db-bar h-full rounded-full" :class="dbColor(device.lastDbLevel)" :style="'width: ' + dbPercent(device.lastDbLevel) + '%'"></div>
                  </div>
                </div>
                <template x-for="cfg in (device.configs || []).filter(c => c.isEnabled)" :key="cfg.id">
                  <div class="py-3 border-t border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center gap-2">
                        <span class="text-sm font-medium" x-text="cfg.soundtrackZoneName || cfg.soundtrackZoneId"></span>
                        <template x-if="cfg.isPaused"><span class="text-xs bg-yellow-600/30 text-yellow-400 px-2 py-0.5 rounded">PAUSED</span></template>
                      </div>
                      <div class="flex items-center gap-3">
                        <button @click="toggleZonePause(cfg)" :class="cfg.isPaused ? 'text-green-400' : 'text-yellow-400'" class="text-xs font-medium"><span x-text="cfg.isPaused ? 'Resume' : 'Pause'"></span></button>
                        <span class="text-sm font-mono w-8 text-right" x-text="cfg.currentVolume"></span>
                      </div>
                    </div>
                    <div class="flex items-center gap-1 mb-2" :class="cfg.isPaused ? 'opacity-40' : ''">
                      <template x-for="i in 17" :key="i"><div class="w-2 h-4 rounded-sm" :class="(i-1) <= cfg.currentVolume ? 'bg-indigo-500' : 'bg-gray-600'"></div></template>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-gray-400">
                      <span>Sensitivity:</span>
                      <input type="range" :value="paramsToSensitivity(cfg.quietThresholdDb, cfg.loudThresholdDb)" @change="quickUpdateSensitivity(cfg, $event.target.value)" min="1" max="5" step="1" class="flex-1 max-w-32">
                      <span x-text="sensitivityLabel(paramsToSensitivity(cfg.quietThresholdDb, cfg.loudThresholdDb))"></span>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>

          <template x-if="devices.filter(d => !d.isOnline).length > 0">
            <div class="mt-6">
              <button @click="showOffline = !showOffline" class="flex items-center gap-2 text-sm text-gray-400 hover:text-gray-300 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform" :class="showOffline ? 'rotate-90' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                <span x-text="'Offline (' + devices.filter(d => !d.isOnline).length + ')'"></span>
              </button>
              <div x-show="showOffline" x-transition class="grid gap-3">
                <template x-for="device in devices.filter(d => !d.isOnline)" :key="device.id">
                  <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <div>
                          <p class="font-medium text-gray-400" x-text="deviceDisplayName(device)"></p>
                          <p class="text-xs text-gray-500" x-text="device.lastSeen ? 'Last seen: ' + timeAgo(device.lastSeen) : 'Never'"></p>
                        </div>
                      </div>
                      <span class="text-xs text-gray-500" x-text="(device.configs || []).length + ' zone(s)'"></span>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>

        <!-- Onboarding Wizard Modal -->
        <div x-show="wizard.active" x-cloak class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
          <div class="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg" @click.away="wizard.active = false">
            <div class="p-6">
              <div class="flex items-center justify-center gap-0 mb-8">
                <template x-for="s in 3" :key="s">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" :class="wizard.step >= s ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-400'"><span x-text="s"></span></div>
                    <div x-show="s < 3" class="w-12 h-0.5" :class="wizard.step > s ? 'bg-indigo-600' : 'bg-gray-700'"></div>
                  </div>
                </template>
              </div>
              <div x-show="wizard.step === 1">
                <h3 class="text-lg font-semibold mb-1">Find Your Account</h3>
                <p class="text-sm text-gray-400 mb-4">Search for your Soundtrack Your Brand account.</p>
                <div class="flex gap-2 mb-4">
                  <input type="text" x-model="accountSearch" @keydown.enter="searchAccounts()" placeholder="Account name..." class="bg-gray-700 border border-gray-600 rounded px-3 py-2 flex-1 text-white placeholder-gray-500" autofocus>
                  <button @click="searchAccounts()" :disabled="searching" class="bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-600 px-4 py-2 rounded text-sm transition"><span x-show="!searching">Search</span><span x-show="searching">...</span></button>
                </div>
                <div x-show="accounts.length > 0" class="space-y-2 max-h-48 overflow-y-auto">
                  <template x-for="acct in accounts" :key="acct.id">
                    <button @click="wizardSelectAccount(acct)" class="w-full text-left bg-gray-700 hover:bg-gray-600 rounded p-3 text-sm transition" :class="selectedAccountId === acct.id ? 'ring-2 ring-indigo-500' : ''"><span x-text="acct.name"></span></button>
                  </template>
                </div>
              </div>
              <div x-show="wizard.step === 2">
                <h3 class="text-lg font-semibold mb-1">Select Zone</h3>
                <p class="text-sm text-gray-400 mb-4">Choose the zone this device will control.</p>
                <div x-show="zones.length === 0" class="text-gray-500 text-sm py-4 text-center">Loading zones...</div>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                  <template x-for="z in zones" :key="z.id">
                    <button @click="wizardSelectZone(z)" class="w-full text-left bg-gray-700 hover:bg-gray-600 rounded p-3 transition"><p class="text-sm font-medium" x-text="z.name"></p><p class="text-xs text-gray-400" x-text="z.locationName"></p></button>
                  </template>
                </div>
                <button @click="wizard.step = 1" class="mt-4 text-sm text-gray-400 hover:text-gray-300">Back</button>
              </div>
              <div x-show="wizard.step === 3">
                <h3 class="text-lg font-semibold mb-1">Confirm Setup</h3>
                <div class="bg-gray-700/50 rounded-lg p-4 space-y-3 mb-6">
                  <div class="flex justify-between text-sm"><span class="text-gray-400">Device</span><span x-text="wizard.deviceName"></span></div>
                  <div class="flex justify-between text-sm"><span class="text-gray-400">Account</span><span x-text="accounts.find(a => a.id === selectedAccountId)?.name || ''"></span></div>
                  <div class="flex justify-between text-sm"><span class="text-gray-400">Zone</span><span x-text="zones.find(z => z.id === selectedZoneId)?.name || ''"></span></div>
                </div>
                <div class="flex gap-3">
                  <button @click="completeWizard()" :disabled="saving" class="flex-1 bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-600 px-4 py-2.5 rounded text-sm font-medium transition"><span x-show="!saving">Complete Setup</span><span x-show="saving">Setting up...</span></button>
                  <button @click="wizard.step = 2" class="bg-gray-700 hover:bg-gray-600 px-4 py-2.5 rounded text-sm transition">Back</button>
                </div>
              </div>
            </div>
            <div class="border-t border-gray-700 px-6 py-3 flex justify-end">
              <button @click="wizard.active = false" class="text-sm text-gray-400 hover:text-gray-300">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </template>

    <!-- Toast -->
    <div x-show="toast.show" x-transition class="fixed bottom-6 right-6 px-4 py-3 rounded-lg shadow-lg text-sm" :class="toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'">
      <span x-text="toast.message"></span>
    </div>

  </main>

  <!-- Footer (customer mode only) -->
  <footer x-show="isCustomerMode" class="px-8 py-4 mt-auto">
    <div class="max-w-6xl mx-auto flex items-center justify-between text-sm">
      <span class="text-gray-500">Soundtrack Auto-Volume</span>
      <span class="text-gray-500">Powered by <span class="text-brand-orange">BMAsia</span></span>
    </div>
  </footer>

  <script>
    const API = window.location.origin + '/api';
    const urlParams = new URLSearchParams(window.location.search);

    function app() {
      return {
        // Mode detection
        accountId: urlParams.get('account'),
        isCustomerMode: !!urlParams.get('account'),

        // Shared state
        tab: 'devices',
        devices: [],
        deviceConfigs: [],
        selectedDeviceId: '',
        accounts: [],
        zones: [],
        selectedAccountId: '',
        selectedZoneId: '',
        accountSearch: '',
        searching: false,
        saving: false,
        monitoring: false,
        monitorInterval: null,
        toast: { show: false, message: '', type: 'success' },
        editingConfigId: null,
        editConfig: { sensitivity: 3, reactivity: 2, minVolume: 4, maxVolume: 12 },
        savingConfig: false,
        newConfig: { sensitivity: 3, reactivity: 2, minVolume: 4, maxVolume: 12 },
        renamingDeviceId: null,
        renameValue: '',
        showOffline: false,
        showHelp: false,
        wizard: { active: false, step: 1, deviceId: null, deviceName: '' },

        // Customer mode state
        addingZoneForDevice: null,
        customerZones: [],

        async init() {
          await this.loadDevices();
          // Customer mode: auto-start polling
          if (this.isCustomerMode) {
            this.startMonitoring();
          }
        },

        switchTab(newTab) {
          const oldTab = this.tab;
          this.tab = newTab;
          if (newTab === 'monitor' && !this.monitoring) this.startMonitoring();
          else if (oldTab === 'monitor' && newTab !== 'monitor' && this.monitoring) this.stopMonitoring();
        },

        startMonitoring() {
          this.monitoring = true;
          this.loadDevices();
          this.monitorInterval = setInterval(() => this.loadDevices(), 2000);
        },

        stopMonitoring() {
          clearInterval(this.monitorInterval);
          this.monitorInterval = null;
          this.monitoring = false;
        },

        deviceDisplayName(device) {
          if (device.name) return device.name;
          const firstConfig = (device.configs || [])[0];
          if (firstConfig?.soundtrackZoneName) return firstConfig.soundtrackZoneName;
          return device.deviceId;
        },

        unconfiguredOnlineDevices() {
          return this.devices.filter(d => d.isOnline && (d.configs || []).length === 0);
        },

        startRename(device) {
          this.renamingDeviceId = device.id;
          this.renameValue = device.name || '';
        },

        async saveRename(device) {
          if (!this.renameValue.trim()) { this.renamingDeviceId = null; return; }
          try {
            await fetch(`${API}/devices/${device.id}/name`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: this.renameValue.trim() }) });
            device.name = this.renameValue.trim();
            this.renamingDeviceId = null;
            this.showToast('Device renamed', 'success');
          } catch (e) { this.showToast('Failed to rename', 'error'); }
        },

        // --- Customer mode: add zone ---
        async startAddZone(device) {
          this.addingZoneForDevice = device.id;
          this.customerZones = [];
          const accountId = device.soundtrackAccountId || this.accountId;
          if (!accountId) { this.showToast('No account ID linked to this device', 'error'); return; }
          try {
            const res = await fetch(`${API}/soundtrack/accounts/${accountId}/zones`);
            this.customerZones = await res.json();
            if (this.customerZones.length === 0) this.showToast('No zones found for this account', 'error');
          } catch (e) { this.showToast('Failed to load zones', 'error'); }
        },

        async addZoneToDevice(device, zone) {
          this.saving = true;
          const accountId = device.soundtrackAccountId || this.accountId;
          try {
            const res = await fetch(`${API}/configs/quick-setup`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                deviceId: device.id,
                soundtrackAccountId: accountId,
                soundtrackAccountName: '',
                soundtrackZoneId: zone.id,
                soundtrackZoneName: zone.name,
              }),
            });
            if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed'); }
            this.addingZoneForDevice = null;
            this.showToast(`Zone "${zone.name}" added!`, 'success');
            await this.loadDevices();
          } catch (e) { this.showToast(e.message, 'error'); }
          this.saving = false;
        },

        async resetDevice(device) {
          if (!confirm('This will restart the device and require WiFi setup again. Continue?')) return;
          try {
            await fetch(`${API}/devices/${device.id}/reset`, { method: 'POST' });
            this.showToast('Reset command sent — device will restart', 'success');
            setTimeout(() => this.loadDevices(), 3000);
          } catch (e) { this.showToast('Failed to send reset command', 'error'); }
        },

        // Quick inline update helpers (customer mode)
        async quickUpdateReactivity(cfg, level) {
          const params = this.reactivityToParams(parseInt(level));
          try {
            await fetch(`${API}/configs/${cfg.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) });
            cfg.smoothingFactor = params.smoothingFactor;
            cfg.sustainCount = params.sustainCount;
          } catch (e) { this.showToast('Failed to update reactivity', 'error'); }
        },

        async quickUpdateField(cfg, field, value) {
          try {
            await fetch(`${API}/configs/${cfg.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ [field]: value }) });
            cfg[field] = value;
          } catch (e) { this.showToast('Failed to update', 'error'); }
        },

        // --- Wizard (admin mode) ---
        startWizard(device) {
          this.wizard = { active: true, step: 1, deviceId: device.id, deviceName: this.deviceDisplayName(device) };
          this.accounts = []; this.zones = []; this.selectedAccountId = ''; this.selectedZoneId = ''; this.accountSearch = '';
        },
        wizardSelectAccount(acct) { this.selectedAccountId = acct.id; this.loadZones(); this.wizard.step = 2; },
        wizardSelectZone(zone) { this.selectedZoneId = zone.id; this.wizard.step = 3; },
        async completeWizard() {
          this.saving = true;
          const zone = this.zones.find(z => z.id === this.selectedZoneId);
          const account = this.accounts.find(a => a.id === this.selectedAccountId);
          try {
            const res = await fetch(`${API}/configs/quick-setup`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ deviceId: this.wizard.deviceId, soundtrackAccountId: this.selectedAccountId, soundtrackAccountName: account?.name || '', soundtrackZoneId: this.selectedZoneId, soundtrackZoneName: zone?.name || '' }) });
            if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Setup failed'); }
            this.wizard.active = false;
            this.showToast('Setup complete!', 'success');
            await this.loadDevices();
          } catch (e) { this.showToast(e.message, 'error'); }
          this.saving = false;
        },

        // --- Zone controls ---
        async toggleZonePause(cfg) {
          try {
            const res = await fetch(`${API}/configs/${cfg.id}/pause`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ isPaused: !cfg.isPaused }) });
            if (!res.ok) throw new Error('Failed');
            cfg.isPaused = !cfg.isPaused;
            this.showToast(cfg.isPaused ? 'Zone paused' : 'Zone resumed', 'success');
          } catch (e) { this.showToast('Failed to update pause state', 'error'); }
        },

        async quickUpdateSensitivity(cfg, level) {
          const sensParams = this.sensitivityToParams(parseInt(level));
          try {
            await fetch(`${API}/configs/${cfg.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sensParams) });
            cfg.quietThresholdDb = sensParams.quietThresholdDb;
            cfg.loudThresholdDb = sensParams.loudThresholdDb;
          } catch (e) { this.showToast('Failed to update sensitivity', 'error'); }
        },

        // --- Data loading ---
        async loadDevices() {
          try {
            const url = this.accountId ? `${API}/devices?account=${encodeURIComponent(this.accountId)}` : `${API}/devices`;
            const res = await fetch(url);
            this.devices = await res.json();
          } catch (e) { this.showToast('Failed to load devices', 'error'); }
        },

        selectDevice(device) { this.selectedDeviceId = device.id; this.tab = 'config'; this.loadDeviceConfigs(); },

        async loadDeviceConfigs() {
          if (!this.selectedDeviceId) { this.deviceConfigs = []; return; }
          try { const res = await fetch(`${API}/configs/device/${this.selectedDeviceId}`); this.deviceConfigs = await res.json(); } catch (e) { this.showToast('Failed to load configs', 'error'); }
        },

        async searchAccounts() {
          if (!this.accountSearch.trim()) return;
          this.searching = true; this.accounts = []; this.zones = []; this.selectedAccountId = ''; this.selectedZoneId = '';
          try { const res = await fetch(`${API}/soundtrack/accounts?q=${encodeURIComponent(this.accountSearch)}`); this.accounts = await res.json(); if (this.accounts.length === 0) this.showToast('No accounts found', 'error'); } catch (e) { this.showToast('Search failed', 'error'); }
          this.searching = false;
        },

        async loadZones() {
          if (!this.selectedAccountId) { this.zones = []; return; }
          this.zones = []; this.selectedZoneId = '';
          try { const res = await fetch(`${API}/soundtrack/accounts/${this.selectedAccountId}/zones`); this.zones = await res.json(); } catch (e) { this.showToast('Failed to load zones', 'error'); }
        },

        async addConfig() {
          if (!this.selectedDeviceId || !this.selectedZoneId) return;
          this.saving = true;
          const zone = this.zones.find(z => z.id === this.selectedZoneId);
          const account = this.accounts.find(a => a.id === this.selectedAccountId);
          const sensParams = this.sensitivityToParams(this.newConfig.sensitivity);
          const reactParams = this.reactivityToParams(this.newConfig.reactivity);
          try {
            const res = await fetch(`${API}/configs`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ deviceId: this.selectedDeviceId, soundtrackAccountId: this.selectedAccountId, soundtrackAccountName: account?.name || '', soundtrackZoneId: this.selectedZoneId, soundtrackZoneName: zone?.name || '', minVolume: this.newConfig.minVolume, maxVolume: this.newConfig.maxVolume, quietThresholdDb: sensParams.quietThresholdDb, loudThresholdDb: sensParams.loudThresholdDb, smoothingFactor: reactParams.smoothingFactor, sustainCount: reactParams.sustainCount }) });
            if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed to save'); }
            this.showToast('Zone config added!', 'success');
            this.selectedAccountId = ''; this.selectedZoneId = ''; this.accounts = []; this.zones = []; this.accountSearch = '';
            await this.loadDeviceConfigs(); await this.loadDevices();
          } catch (e) { this.showToast(e.message, 'error'); }
          this.saving = false;
        },

        async toggleConfig(cfg) {
          try { await fetch(`${API}/configs/${cfg.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ isEnabled: !cfg.isEnabled }) }); cfg.isEnabled = !cfg.isEnabled; } catch (e) { this.showToast('Failed to update config', 'error'); }
        },

        async deleteConfig(id, device) {
          if (!confirm('Remove this zone?')) return;
          try { await fetch(`${API}/configs/${id}`, { method: 'DELETE' }); this.deviceConfigs = this.deviceConfigs.filter(c => c.id !== id); if (device) { device.configs = (device.configs || []).filter(c => c.id !== id); } this.showToast('Zone removed', 'success'); } catch (e) { this.showToast('Failed to delete', 'error'); }
        },

        toggleMonitoring() { this.monitoring ? this.stopMonitoring() : this.startMonitoring(); },

        // --- Mapping functions ---
        sensitivityToParams(level) {
          const map = { 1: { quietThresholdDb: -78, loudThresholdDb: -30 }, 2: { quietThresholdDb: -76, loudThresholdDb: -38 }, 3: { quietThresholdDb: -74, loudThresholdDb: -45 }, 4: { quietThresholdDb: -72, loudThresholdDb: -50 }, 5: { quietThresholdDb: -70, loudThresholdDb: -55 } };
          return map[level] || map[3];
        },
        reactivityToParams(level) {
          const map = { 1: { smoothingFactor: 0.1, sustainCount: 4 }, 2: { smoothingFactor: 0.2, sustainCount: 3 }, 3: { smoothingFactor: 0.3, sustainCount: 2 }, 4: { smoothingFactor: 0.5, sustainCount: 2 }, 5: { smoothingFactor: 0.7, sustainCount: 1 } };
          return map[level] || map[3];
        },
        paramsToSensitivity(quietDb, loudDb) { const r = loudDb - quietDb; if (r >= 43) return 1; if (r >= 33) return 2; if (r >= 25) return 3; if (r >= 18) return 4; return 5; },
        paramsToReactivity(sf, sc) { if (sf <= 0.15) return 1; if (sf <= 0.25) return 2; if (sf <= 0.4) return 3; if (sf <= 0.6) return 4; return 5; },
        sensitivityLabel(l) { return ['', 'Very Low', 'Low', 'Medium', 'High', 'Very High'][l] || 'Medium'; },
        reactivityLabel(l) { return ['', 'Very Slow', 'Slow', 'Medium', 'Fast', 'Very Fast'][l] || 'Medium'; },

        toggleEditConfig(cfg) {
          if (this.editingConfigId === cfg.id) { this.editingConfigId = null; return; }
          this.editConfig = { sensitivity: this.paramsToSensitivity(cfg.quietThresholdDb, cfg.loudThresholdDb), reactivity: this.paramsToReactivity(cfg.smoothingFactor, cfg.sustainCount || 2), minVolume: cfg.minVolume, maxVolume: cfg.maxVolume };
          this.editingConfigId = cfg.id;
        },

        async saveConfigSettings(cfg) {
          this.savingConfig = true;
          const sp = this.sensitivityToParams(this.editConfig.sensitivity);
          const rp = this.reactivityToParams(this.editConfig.reactivity);
          try {
            const res = await fetch(`${API}/configs/${cfg.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ minVolume: this.editConfig.minVolume, maxVolume: this.editConfig.maxVolume, quietThresholdDb: sp.quietThresholdDb, loudThresholdDb: sp.loudThresholdDb, smoothingFactor: rp.smoothingFactor, sustainCount: rp.sustainCount }) });
            if (!res.ok) throw new Error('Failed to save');
            Object.assign(cfg, { minVolume: this.editConfig.minVolume, maxVolume: this.editConfig.maxVolume, quietThresholdDb: sp.quietThresholdDb, loudThresholdDb: sp.loudThresholdDb, smoothingFactor: rp.smoothingFactor, sustainCount: rp.sustainCount });
            this.editingConfigId = null;
            this.showToast('Settings saved', 'success');
          } catch (e) { this.showToast('Failed to save settings', 'error'); }
          this.savingConfig = false;
        },

        dbPercent(db) { return db == null ? 0 : Math.max(0, Math.min(100, ((db + 80) / 60) * 100)); },
        dbColor(db) { if (db == null) return 'bg-gray-500'; if (db > -35) return 'bg-red-500'; if (db > -55) return 'bg-yellow-500'; return 'bg-green-500'; },
        timeAgo(d) { const s = Math.floor((Date.now() - new Date(d).getTime()) / 1000); if (s < 60) return s + 's ago'; const m = Math.floor(s / 60); if (m < 60) return m + 'm ago'; const h = Math.floor(m / 60); if (h < 24) return h + 'h ago'; return Math.floor(h / 24) + 'd ago'; },
        showToast(message, type = 'success') { this.toast = { show: true, message, type }; setTimeout(() => { this.toast.show = false; }, 3000); },
      };
    }
  </script>
</body>
</html>
